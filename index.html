<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ö–∞—Ç–∞–ª–æ–≥ –æ–≤–æ—â–µ–π –∏ —Ñ—Ä—É–∫—Ç–æ–≤</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#fff;padding-bottom:80px}
.container{max-width:500px;margin:0 auto;padding:15px}
.header{text-align:center;padding:15px 0;border-bottom:1px solid #ddd;margin-bottom:20px;position:relative}
.header h1{color:#2563eb;font-size:22px;margin-bottom:8px}
.cart-total{font-size:20px;font-weight:bold;color:#2563eb}
.refresh-btn{position:absolute;top:15px;right:15px;background:#2563eb;color:#fff;border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background 0.3s}
.refresh-btn:hover{background:#1d4ed8}
.refresh-btn:active{transform:scale(0.95)}
.product{display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px}
.product-info{flex:1}
.product-name{font-size:16px;font-weight:500;margin-bottom:3px}
.product-price{font-size:14px;color:#666}
.controls{display:flex;align-items:center;gap:12px}
.btn{width:36px;height:36px;border:none;background:#2563eb;color:#fff;border-radius:6px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.btn:disabled{background:#ccc;cursor:not-allowed}
.qty{font-size:16px;font-weight:bold;min-width:25px;text-align:center}
.filters{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.filter-btn{padding:8px 12px;border:2px solid #2563eb;background:#fff;color:#2563eb;border-radius:20px;font-size:14px;cursor:pointer;transition:all 0.3s}
.filter-btn.active{background:#2563eb;color:#fff}
.filter-btn:hover{background:#f0f4ff}
.footer{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:15px;border-top:3px solid #2563eb;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}
.order-btn{width:100%;padding:16px;border:none;background:#2563eb;color:#fff;font-size:18px;font-weight:bold;border-radius:8px;cursor:pointer}
.order-btn:disabled{background:#999;cursor:not-allowed}
.status{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:3px solid #2563eb;border-radius:12px;padding:25px;z-index:1000;text-align:center;min-width:250px;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.status.hidden{display:none}
.spinner{width:40px;height:40px;border:4px solid #eee;border-top:4px solid #2563eb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ü•ï –°–≤–µ–∂–∏–µ –æ–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã</h1>
    <div class="cart-total">–°—É–º–º–∞: <span id="total">0</span>‚ÇΩ</div>
    <button onclick="loadProducts()" class="refresh-btn" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥">üîÑ</button>
  </div>
  
  <div class="filters">
    <button class="filter-btn active" onclick="filterProducts('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterProducts('–û–≤–æ—â–∏')">ü•¨ –û–≤–æ—â–∏</button>
    <button class="filter-btn" onclick="filterProducts('–§—Ä—É–∫—Ç—ã')">üçé –§—Ä—É–∫—Ç—ã</button>
    <button class="filter-btn" onclick="filterProducts('–ó–µ–ª–µ–Ω—å')">üåø –ó–µ–ª–µ–Ω—å</button>
    <button class="filter-btn" onclick="filterProducts('–ì—Ä–∏–±—ã')">üçÑ –ì—Ä–∏–±—ã</button>
  </div>
  
  <div id="products"></div>
</div>

<div class="footer">
  <button id="order-btn" class="order-btn" disabled>–ú–∏–Ω. –∑–∞–∫–∞–∑ 1200‚ÇΩ</button>
</div>

<div id="status" class="status hidden">
  <div class="spinner"></div>
  <div id="status-text">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑...</div>
</div>

<script>
const tg=window.Telegram.WebApp;
if(tg){tg.ready();tg.expand();}

// URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets (CSV —Ñ–æ—Ä–º–∞—Ç)
const SHEETS_URL = 'https://docs.google.com/spreadsheets/d/14WPvmY8cIFufe5VKRcvDYP2vCI9bhq9vILUsMbzRZXk/export?format=csv';

let products = [];

let cart={};
let currentFilter='all';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
async function loadProducts() {
  try {
    showLoading(true);
    
    const response = await fetch(SHEETS_URL);
    if (!response.ok) {
      throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
    
    const csvText = await response.text();
    const lines = csvText.split('\n');
    
    products = [];
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
      
      const columns = parseCSVLine(line);
      if (columns.length >= 4) {
        const name = columns[0].replace(/"/g, '').trim();
        const priceStr = columns[1].replace(/"/g, '').trim();
        const unit = columns[2].replace(/"/g, '').trim();
        const category = columns[3].replace(/"/g, '').trim();
        
        // –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É, —É–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
        const price = parseInt(priceStr.replace(/[^\d]/g, ''));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
        if (name && !isNaN(price) && price > 0 && unit && category) {
          products.push({
            id: products.length + 1,
            name: name,
            price: price,
            unit: unit,
            category: category
          });
        }
      }
    }
    
    if (products.length === 0) {
      throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ');
    }
    
    showLoading(false);
    render();
    updateTotal();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
    showLoading(false);
    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
function showLoading(show) {
  const productsContainer = document.getElementById('products');
  if (show) {
    productsContainer.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥...</p>
      </div>
    `;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
function showError(message) {
  const productsContainer = document.getElementById('products');
  productsContainer.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
      <p style="color: #e74c3c; margin-bottom: 15px;">${message}</p>
      <button onclick="loadProducts()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
      </button>
    </div>
  `;
}

function filterProducts(category){
currentFilter=category;
document.querySelectorAll('.filter-btn').forEach(btn=>btn.classList.remove('active'));
event.target.classList.add('active');
render();
}

function render(){
const filteredProducts=currentFilter==='all'?products:products.filter(p=>p.category===currentFilter);
document.getElementById('products').innerHTML=filteredProducts.map(p=>
`<div class="product">
  <div class="product-info">
    <div class="product-name">${p.name}</div>
    <div class="product-price">${p.price}‚ÇΩ/${p.unit}</div>
  </div>
  <div class="controls">
    <button class="btn" onclick="change(${p.id},-1)" ${!cart[p.id]?'disabled':''}>‚àí</button>
    <span class="qty" id="q${p.id}">${cart[p.id]||0}</span>
    <button class="btn" onclick="change(${p.id},1)">+</button>
  </div>
</div>`
).join('');
}

function change(id,delta){
cart[id]=Math.max(0,(cart[id]||0)+delta);
if(!cart[id])delete cart[id];
document.getElementById('q'+id).textContent=cart[id]||0;
updateTotal();
}

function updateTotal(){
const total=Object.entries(cart).reduce((sum,[id,qty])=>{
const product=products.find(p=>p.id==id);
return sum+(product.price*qty);
},0);
document.getElementById('total').textContent=total;
const btn=document.getElementById('order-btn');
if(total>=1200){
btn.disabled=false;
btn.textContent=`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ${total}‚ÇΩ`;
}else{
btn.disabled=true;
btn.textContent=`–ú–∏–Ω. –∑–∞–∫–∞–∑ 1200‚ÇΩ (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${1200-total}‚ÇΩ)`;
}
}

function submitOrder(){
const total=+document.getElementById('total').textContent;
if(total<1200)return;

const items=Object.entries(cart).map(([id,qty])=>{
const p=products.find(x=>x.id==id);
return `${p.name} ‚Äì ${qty} ${p.unit} (${p.price*qty}‚ÇΩ)`;
}).join('\n');

const user=tg.initDataUnsafe.user||{};
const orderData={
cart:cart,
items:items,
total:total,
orderTime:new Date().toLocaleString('ru-RU'),
telegram_user_id:user.id,
telegram_username:user.username,
telegram_first_name:user.first_name,
telegram_last_name:user.last_name
};

document.getElementById('status').classList.remove('hidden');
document.getElementById('status-text').textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑...';

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp API
tg.sendData(JSON.stringify(orderData));

setTimeout(()=>{
document.getElementById('status-text').textContent='‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
setTimeout(()=>{
cart={};
render();
updateTotal();
document.getElementById('status').classList.add('hidden');
// –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
if(tg.close)tg.close();
},2000);
},500);
}

document.getElementById('order-btn').onclick=submitOrder;

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
loadProducts();
</script>
</body>
</html>